#!/bin/bash
# 30-docker.sh.example - Install Docker tools and utilities
# Rename this file to 30-docker.sh to enable

# Source common utilities
source /workspace/scripts/lib/common.sh

print_status "Installing Docker development tools..."

# Install Docker Engine if not already installed
if ! command_exists docker; then
    print_status "Installing Docker Engine..."

    # Add Docker's official GPG key and repository
    if command_exists apt-get; then
        if sudo apt-get update; then
            sudo apt-get install -y ca-certificates curl gnupg || print_warning "Failed to install prerequisites"

            # Add Docker's official GPG key
            sudo install -m 0755 -d /etc/apt/keyrings
            if curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg 2>/dev/null; then
                sudo chmod a+r /etc/apt/keyrings/docker.gpg

                # Set up Docker repository
                echo \
                  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
                  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
                  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

                # Install Docker Engine
                if sudo apt-get update && sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin; then
                    # Add current user to docker group
                    sudo usermod -aG docker "$USER" || print_warning "Failed to add user to docker group"
                    print_success "Docker Engine installed successfully"
                else
                    print_warning "Failed to install Docker Engine packages"
                fi
            else
                print_warning "Failed to add Docker GPG key"
            fi
        else
            print_warning "Failed to update package lists"
        fi
    else
        print_warning "apt-get not available, cannot install Docker Engine"
    fi
else
    print_debug "Docker Engine already installed"
fi

# Docker Compose (if not already installed)
if ! command_exists docker-compose; then
    print_status "Installing Docker Compose..."

    COMPOSE_VERSION="v2.39.2"
    TEMP_FILE="/tmp/docker-compose-$$"

    if curl -L "https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" \
       -o "${TEMP_FILE}" 2>/dev/null; then
        if sudo mv "${TEMP_FILE}" /usr/local/bin/docker-compose && \
           sudo chmod +x /usr/local/bin/docker-compose; then
            print_success "Docker Compose installed: $(docker-compose --version)"
        else
            rm -f "${TEMP_FILE}"
            print_warning "Failed to install Docker Compose"
        fi
    else
        rm -f "${TEMP_FILE}"
        print_warning "Failed to download Docker Compose"
    fi
fi

# Docker development utilities
print_status "Installing Docker utilities..."

# Install standalone binaries
if command_exists wget; then
    # Install dive
    if ! command_exists dive; then
        print_debug "Installing dive..."
        DIVE_VERSION="0.13.1"
        DEB_FILE="dive_${DIVE_VERSION}_linux_amd64.deb"

        if wget -q "https://github.com/wagoodman/dive/releases/download/v${DIVE_VERSION}/${DEB_FILE}"; then
            if sudo dpkg -i "${DEB_FILE}" 2>/dev/null; then
                rm -f "${DEB_FILE}"
                print_debug "✓ dive installed"
            else
                rm -f "${DEB_FILE}"
                print_warning "Failed to install dive"
            fi
        else
            rm -f "${DEB_FILE}"
            print_warning "Failed to download dive"
        fi
    fi

    # Install ctop
    if ! command_exists ctop; then
        print_debug "Installing ctop..."
        TEMP_FILE="/tmp/ctop-$$"

        if wget -q "https://github.com/bcicen/ctop/releases/download/v0.7.7/ctop-0.7.7-linux-amd64" \
           -O "${TEMP_FILE}"; then
            if sudo mv "${TEMP_FILE}" /usr/local/bin/ctop && \
               sudo chmod +x /usr/local/bin/ctop; then
                print_debug "✓ ctop installed"
            else
                rm -f "${TEMP_FILE}"
                print_warning "Failed to install ctop"
            fi
        else
            rm -f "${TEMP_FILE}"
            print_warning "Failed to download ctop"
        fi
    fi
fi

# Create useful Docker aliases
print_status "Creating Docker aliases..."

docker_aliases="
# Docker aliases
alias dps='docker ps'
alias dpa='docker ps -a'
alias di='docker images'
alias drmi='docker rmi'
alias dstop='docker stop'
alias dstart='docker start'
alias drestart='docker restart'
alias dlogs='docker logs'
alias dexec='docker exec -it'
alias dclean='docker system prune -f'
alias dcleanall='docker system prune -a -f'

# Docker Compose aliases
alias dc='docker-compose'
alias dcup='docker-compose up'
alias dcdown='docker-compose down'
alias dcbuild='docker-compose build'
alias dclogs='docker-compose logs'
"

echo "$docker_aliases" >> ~/.bashrc

print_success "Docker development tools configured"
